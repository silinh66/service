/*
 * (C) 2025 MARS FLAG Corporation
 * http://www.marsflag.com/
  Version: 1.2.1
  Build Time: 2025/8/20 9:44:06
  Env: prd
 */
"use strict";(()=>{var u={JSON_BASE_URL:"https://s.mp.marsflag.com/config",CE_BASE_URL:"https://ce.mf.marsflag.com"},r=(n,e=null,o="debug")=>{if(!document.cookie.split("; ").find(a=>a.startsWith("mf_debug=")))return;let t={prefix:"color: yellow; background-color: black; font-size: 14px; font-weight: bold; padding: 2px;",message:"color: limegreen; background-color: black; font-size: 14px; padding: 2px;",error:"color: red; background-color: black; font-size: 14px; padding: 2px;",info:"color: cyan; background-color: black; font-size: 14px; padding: 2px;",data:"color: white; background-color: black; font-size: 14px; padding: 2px;"},c=o.toUpperCase(),i=o==="debug"?t.message:t[o];e?console[o](`%c${c}: %c${n}`,t.prefix,i,e):console[o](`%c${c}: %c${n}`,t.prefix,i)},f=()=>{let n=document.querySelector("mf-search-results"),e=document.querySelector("mf-search-box"),o=n||e,s=(n==null?void 0:n.getAttribute("ajax-url"))||(e==null?void 0:e.getAttribute("ajax-url"))||null;return o&&!s&&r("Elements exist but ajax-url attribute is missing",null,"error"),s},g=n=>{let e=n.match(/documents\/(.+?)\/search/),o=e?e[1]:null;return o||r(`Failed to get unique name from ajax-url: ${n}`,null,"error"),o},p=()=>{let n=window.location.search+window.location.hash;return new URLSearchParams(n.slice(1)).get("force_version")},m=(n,e)=>new Promise((o,s)=>{let t=document.createElement("script");t.async=!0,t.type=e,t.src=n,t.onload=()=>{r("Script loaded:",n),o()},t.onerror=()=>{r("Failed to load script:",n,"error"),s(new Error(`Failed to load script: ${n}`))},document.body.appendChild(t)}),d=()=>m(`${u.CE_BASE_URL}/v1/js/mf-search.js`,"text/javascript"),_=n=>{let e=`${u.CE_BASE_URL}/v2/js/mf-search.js`,o=n?`${e}?emotech_unique_name=${n}`:e;return m(o,"module")},h=async n=>{if(localStorage.getItem("use_test_json")==="true")return r("Using test JSON data",null,"info"),JSON.parse(localStorage.getItem("test_json_data")||"{}");try{let e=await fetch(`${u.JSON_BASE_URL}/${n}.json`);if(!e.ok)throw new Error(`JSON file not found for ${n}`);return await e.json()}catch(e){return e instanceof SyntaxError?r("JSON format error",e,"error"):r(e instanceof Error?e.message:String(e),null,"error"),{}}},E=(n,e,o)=>{var s,t,c,i;try{let a=o||((t=(s=n.mf3)==null?void 0:s.find(l=>l.unique_name===e))==null?void 0:t.setting.ce_version)||((i=(c=n.di)==null?void 0:c.find(l=>l.unique_name===e))==null?void 0:i.setting.ce_version);return a?Number(a):(r("Version not found in JSON data",null,"error"),2)}catch(a){return r("Error determining version",a,"error"),2}},S=(n,e)=>{var o,s;try{let t=(o=n.mf3)==null?void 0:o.find(l=>l.unique_name===e),c=(s=n.di)==null?void 0:s.find(l=>l.unique_name===e),i=t||c;if(r(`Using ${t?"mf3":"di"} entry for ${e}`,i),!i)return null;if(i.load!==void 0&&i.load!==1)return r("load is specified but not 1, stopping all script loading",i.load,"info"),"STOP_LOADING";if(Number(i.setting.ce_version)!==2||!i.setting.emotech_unique_name)return null;let a=i.setting.emotech_unique_name;return r("EmoTech in Finder is enabled",{searchUniqueName:e,emotechUniqueName:a},"info"),a}catch(t){return r("Error checking EmoTech in Finder status",t,"error"),null}},b=async()=>{try{let n=document.querySelector("mf-search-results"),e=document.querySelector("mf-search-box");!n&&!e&&r("No search components found on page",null,"info");let o=f();o||r("No ajax-url found",null,"error"),r("Element with ajax-url found:",o);let s=g(o);s||r("Unique name not found",null,"error"),r("Unique Name:",s);let t=p();r("Forced version:",t||"Not forced");let c=await h(s);r("JSON Data:",c);let i=E(c,s,t);r("CE version:",i);let a=S(c,s);if(r("EmoTech Check Result:",a),a==="STOP_LOADING"){r("Stopping script loading due to mf3 load configuration",null,"info");return}if(i===1)r("Loading v1 code",i),await d();else{let l=a;r("Loading v2 code",{version:i,emotechUniqueName:l}),setTimeout(()=>{_(l||void 0)},0)}}catch(n){r("Error during initialization",n,"error");try{await d()}catch(e){r("Failed to load fallback script",e,"error")}}};b();})();
